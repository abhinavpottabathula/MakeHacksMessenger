<!DOCTYPE html>
<html>
  <head>
    <!-- firebase cdn -->
    <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

    <!-- jQuery UI -->
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
  	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>

    <!-- Latest compiled JavaScript -->
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <script src="http://cdn.pubnub.com/pubnub-3.7.15.min.js"></script>

    <script src="index.js"></script>
    <link rel="stylesheet" href="index.css">

    <!-- bar graph -->
    <script src="jquery.canvasjs.min.js"></script>
    <script type="text/javascript" src="canvasjs.min.js"></script>

    <!-- Work Sans font -->
    <link href='https://fonts.googleapis.com/css?family=Work+Sans' rel='stylesheet' type='text/css'>

    <!-- Lato Font -->
    <link href='https://fonts.googleapis.com/css?family=Lato:100' rel='stylesheet' type='text/css'>

    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['corechart']}]}"></script>
  </head>
  <body>
    <div class = "login">
      <div class="loginchild">
        <img class="loginlogo" src="DicoLogo.png"/>
        <h1>Dico</h1>
        <p>
          Username:
        </p>
        <input type="text" id="username" name="username" value="">
        <p>
          Password:
        </p>
        <input type="password" id="password" name="password" value="">
        <div class="loginbutton">
          <a id="login">Login</a>
          <a id="sign">Sign Up</a>
        </div>
      </div>
    </div>
    <div class="sign">
      <div class="signchild">
        <h1>Sign Up</h1>
        <p>
          Username:
        </p>
        <input type="text" id="user" name="user" value="">
        <p>
          Password:
        </p>
        <input type="password" id="pass" name="pass" value="">
          <a id="create">Create Account</a>
          <a id="cancel">Cancel</a>
      </div>
    </div>
    <div class="menu">
      <div class="menuheader">
        <h1 id="welcome">Welcome</h1>
        <div class="bar">
          <img style="width:50px;height:auto;float:left;margin-left:20px;"src="add121.png"/>
          <img style="width:50px;height:auto;float:left;margin-left:20px;"src="menu33.png"/>
          <a id="log">Log out</a>
        </div>
        <table class="conversations">
          <tr class="chatbar" id="dico_ch_a">
            <td>
              <img src="food.png" class="icon"/>
            </td>
            <td class="status">
              <p class="title">Foodies</p>
              <p class="members">Abhi, Ani, and 5 others...</p>
            </td>
          </tr>
          <tr class="chatbar" id="dico_ch_b">
            <td>
              <img src="sport.png" class="icon"/>
            </td>
            <td class="status">
              <p class="title">Sporties</p>
              <p class="members">John, Pran, and 11 others...</p>
            </td>
          </tr>
          <tr class="chatbar" id="dico_ch_c">
            <td>
              <img src="paris.png" class="icon"/>
            </td>
            <td class="status">
              <p class="title">French Stress</p>
              <p class="members">Sanket, John, and 32 others...</p>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <div class="chat">
      <div class="topbar">
        <row>
            <div class="col-lg-2" id="buttondiv">
              <img src="" id="image" class="icon" style="display:inline;"/>
              <p id="subject" style="display:inline;">subject</p>
            </div>
            <div class="col-lg-1" id="buttondiv">
              <a href="#" id="exit">exit</a>
            </div>
            <div class="col-lg-8" id="buttondiv" class="col-lg-1">
              <input type="text" id="text" value="" >
            </div>
            <div class="col-lg-1" id="buttondiv">
              <a href="#" id="send">send</a>
            </div>
        </row>
      </div>
      <row>
        <div class="col-lg-1 line">
          <img src="redmenu.png" id="addOp" style="width:5vw;height:auto;margin-top:20px;"/>
          <img src="barAfter.png" id="addBar" style="width:5vw;height:auto;margin-top:20px;"/>
          <img src="pieAfter.png" id="addPie" style="width:5vw;height:auto;margin-top:20px;"/>
        </div>
        <div class="col-lg-11 viewport line">
          <div id="chart" style="width: 900px; height: 500px;"></div>
        </div>
      </row>

      <script src="https://cdn.pubnub.com/pubnub.min.js"></script>
      <script id="apps" charset="utf-8">

        (function(){
          var name = "Rohit";
          $("#login").click(function() {
            if($("#username").val() != "" && $("#password").val() != "") {
              var username = $("#username").val();
              name = username;
            }
          });
          var PUBNUB_demo = PUBNUB.init({
            publish_key: 'pub-c-f09e676a-747a-42d0-a05b-3e0dfad9b292',
            subscribe_key: 'sub-c-ecc9fc54-8b35-11e5-83e3-02ee2ddab7fe'
          });

          var network;

          $("#dico_ch_a").click(function() {
            network = "dico_ch_a";
            $("#image").attr("src", "food.png");
            $("#subject").text("foodies");
            PUBNUB_demo.subscribe({
              channel: 'dico_ch_a',
              message: function(m){
                console.log(JSON.stringify(m));
                pageUI(m)
              },
              connect: button
            });
            PUBNUB_demo.history({
                 channel: 'dico_ch_a',
                 callback: function(arr) {
                   console.log(arr);
                   for(var i = 0; i < arr[0].length; i++) {
                     console.log("post");
                     pageUI(arr[0][i]);
                   }
                 },
                 count: 100, // 100 is the default
                 reverse: false // false is the default
            });
          });
          $("#dico_ch_b").click(function() {
            network = "dico_ch_b";
            $("#image").attr("src", "sport.png");
            $("#subject").text("sporties");
            PUBNUB_demo.subscribe({
              channel: 'dico_ch_b',
              message: function(m){
                console.log(JSON.stringify(m));
                pageUI(m)
              },
              connect: button
            });
            PUBNUB_demo.history({
                 channel: 'dico_ch_b',
                 callback: function(arr) {
                   console.log(arr);
                   for(var i = 0; i < arr[0].length; i++) {
                     pageUI(arr[0][i]);
                   }
                 },
                 count: 100, // 100 is the default
                 reverse: false // false is the default
            });
          });
          $("#dico_ch_c").click(function() {
            $("#image").attr("src", "paris.png");
            $("#subject").text("French Stress");
            network = "dico_ch_c";
            PUBNUB_demo.subscribe({
              channel: 'dico_ch_c',
              message: function(m){
                console.log(JSON.stringify(m));
                pageUI(m)
              },
              connect: button
            });
            PUBNUB_demo.history({
                 channel: 'dico_ch_c',
                 callback: function(arr) {
                   console.log(arr);
                   for(var i = 0; i < arr[0].length; i++) {
                     pageUI(arr[0][i]);
                   }
                 },
                 count: 100, // 100 is the default
                 reverse: true // false is the default
            });
          });

          var messageList = [];
          var opList = [];
          var upvotes = [];
          var voted = [];
          var graphs = [];
          var used = [];
          var id = PUBNUB_demo.uuid();

          function button() {
            $("#send").click(function() {
              console.log($("#text").val());
              if($("#text").val() != "") {
                publish();
                $("#text").val("");
              }

            });

            $("html").click(function(event){
              if($(event.target).attr("class") == "option") {
                var aid = $(event.target).attr("id");
                var ind = opList.indexOf(aid);
                var votes = upvotes[ind] + 1;
                var text = $(event.target).text().substring(0, $(event.target).text().indexOf(","));
                if(jQuery.inArray(name, voted[ind]) == -1 && used[ind] == false) {
                  sendVote(aid, votes, text);
                  used[ind] = true;
                }
              }
            });

          }

          $(document).keypress(function(e){
            if(e.which == 13 && $("#text").val() != "") {
              publish();
              $("#text").val("");
            }
          });

          function sendVote(aid, vote, text) {
            PUBNUB_demo.publish({
              channel: network,
              message: {
                "data" : {
                  "id": aid,
                  "userID": name,
                  "messageID": id + new Date().getTime(),
                  "name": text,
                  "votes": vote
                },
                "type": "upVote"
              }
            });
          }

          function optionClick(op) {
            console.log($(op).attr("id"));
          }

          function removeBlank(s) {
            var res = "";
            var index1 = 0;
            var index2 = 0;
            while(true) {
              index2 = s.indexOf(" ", index1);
              if(index2 == -1) {
                res += s.substring(index1);
                break;
              }
              res += s.substring(index1, index2) + "_";
              index1 = index2 + 1;
            }
            return res;
          }

          function pageUI(m) {
            if(m.type == "groupMessage") {
              messageList.push(m);
              var a = [];
              for(var i = 0; i < m.data.options.length; i++) {
                opList.push(removeBlank(m.data.options[i]) + m.data.messageID);
                a.push(removeBlank(m.data.options[i]) + m.data.messageID);
                upvotes.push(0);
                var arr = [];
                voted.push(arr);
                used.push(false);
              }
              var append = "";
              if(m.data.text.indexOf("<pie>") == -1) {
                if(m.data.userID == name) {
                  append += "<div class='user' style='opacity:0;' id='"+ m.data.messageID +"'><div class='message'><p>" + m.data.text + "</p>";
                  for(var i = 0; i < m.data.options.length; i++) {
                    append += "<a class='option' id='"+ removeBlank(m.data.options[i]) + m.data.messageID +"'>" + m.data.options[i] + ", 0</a>";
                  }
                  if(messageList.length < 2 || messageList[messageList.length - 2].data.userID != m.data.userID) {
                    append += "</div><p class='author'>"+ m.data.userID +"</p></div>";
                  } else {
                    append += "</div></div>";
                  }
                  $(".viewport").prepend(append);
                  if(!(messageList.length < 2) && messageList[messageList.length - 2].data.userID == m.data.userID) {
                    $("#" + messageList[messageList.length - 2].data.messageID + " .message").css("border-top-right-radius", '0px');
                    $("#" + messageList[messageList.length - 2].data.messageID).css("margin-top", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID+ " .message").css("border-bottom-right-radius", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID).css("margin-bottom", '0px');
                  }
                } else {
                  append += "<div class='buddy' style='opacity:0;' id='"+ m.data.messageID +"'><div class='message'><p>" + m.data.text + "</p>";
                  for(var i = 0; i < m.data.options.length; i++) {
                    append += "<a class='option' id='"+ removeBlank(m.data.options[i]) + m.data.messageID +"'>" + m.data.options[i] + ", 0</a>";
                  }
                  if(messageList.length < 2 || messageList[messageList.length -2].data.userID != m.data.userID) {
                    append += "</div><p class='author'>"+ m.data.userID +"</p></div>";
                  } else {
                    append += "</div></div>";
                  }
                  $(".viewport").prepend(append);
                  if(!(messageList.length < 2) && messageList[messageList.length - 2].data.userID == m.data.userID) {
                    $("#" + messageList[messageList.length - 2].data.messageID+ " .message").css("border-top-left-radius", '0px');
                    $("#" + messageList[messageList.length - 2].data.messageID).css("margin-top", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID+ " .message").css("border-bottom-left-radius", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID).css("margin-bottom", '0px');
                  }
                }
                $("#" + messageList[messageList.length - 1].data.messageID).animate({opacity: "1"}, 250);
              } else {
                var prep = "";
                if(m.data.userID == name) {
                  //prep += "<div class='user' style='opacity:0;' id='"+ m.data.messageID +"'>"
                  prep += '<div id="'+ m.data.messageID +'chart" style="width: 900px; height: 500px;"></div>';
                  /*if(messageList.length < 2 || messageList[messageList.length -2].data.userID != m.data.userID) {
                    prep += "<p class='author'>"+ m.data.userID +"</p></div>";
                  } else {
                    prep += "</div>";
                  }*/
                  $(".viewport").prepend(prep);
                  var code = "";
                  debugger;
                  var script = document.createElement( 'script' );
                  script.type = 'text/javascript';
                  $("body").append( script );
                  $(script).append("\ngoogle.setOnLoadCallback(drawChart" + m.data.messageID +");\
                                        \nfunction drawChart"+ m.data.messageID +"() {\
                                        \nvar data = google.visualization.arrayToDataTable("+ m.data.text.substring(m.data.text.indexOf("<pie>") + 5) +");\
                                        \nvar options = {\
                                          \ntitle: 'My Daily Activities', pieHole: 0.4,};\
                                        \nvar chart"+ m.data.messageID +" = new google.visualization.PieChart(document.getElementById('"+ m.data.messageID +"chart'));\
                                        \nchart" + m.data.messageID + ".draw(data, options);\
                                      \n}");
                  /*$("#charts").append('google.load("visualization", "1", {packages:["corechart"]});');
                  $("#charts").append('google.setOnLoadCallback(drawChart);');
                  $("#charts").append('function drawChart() {');
                  $("#charts").append('var data = google.visualization.arrayToDataTable(' + m.data.text.substring(m.data.text.indexOf("<pie>") + 5) + '); var options = {');
                  $("#charts").append("title: '" + m.data.text.substring(0, m.data.text.indexOf('<pie>')) + "', pieHole: 0.4,}; var chart = new google.visualization.PieChart(document.getElementById('"+ m.data.messageID +"chart')); chart.draw(data, options);}");*/
                  //$("#charts").append(code);
                  /*if(!(messageList.length < 2) && messageList[messageList.length - 2].data.userID == m.data.userID) {
                    $("#" + messageList[messageList.length - 2].data.messageID + " .message").css("border-top-right-radius", '0px');
                    $("#" + messageList[messageList.length - 2].data.messageID).css("margin-top", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID+ " .message").css("border-bottom-right-radius", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID).css("margin-bottom", '0px');
                  }*/
                } else {
                  //prep += "<div class='buddy' style='opacity:0;' id='"+ m.data.messageID +"'>"
                  prep += '<div class="message" id="'+ m.data.messageID +'chart" style="width: 900px; height: 500px;"></div>';
                  /*if(messageList.length < 2 || messageList[messageList.length -2].data.userID != m.data.userID) {
                    prep += "</div><p class='author'>"+ m.data.userID +"</p></div>";
                  } else {
                    prep += "</div></div>";
                  }*/
                  $(".viewport").prepend(prep);
                  var code = "";
                  $("#charts").append('google.load("visualization", "1", {packages:["corechart"]});' +
                  "google.setOnLoadCallback(drawChart);function drawChart() {" +
                  "var data = google.visualization.arrayToDataTable("+ m.data.text.substring(m.data.text.indexOf("<pie>") + 5) +");" +
                  "var options = {" +
                    "title: 'My Daily Activities', pieHole: 0.4,};" +
                "var chart = new google.visualization.PieChart(document.getElementById('"+ m.data.messageID +"chart'));" +
                    "chart.draw(data, options);" +
                  "}");
                  /*$("#charts").append('google.load("visualization", "1", {packages:["corechart"]});');
                  $("#charts").append('google.setOnLoadCallback(drawChart);');
                  $("#charts").append('function drawChart() {');
                  $("#charts").append('var data = google.visualization.arrayToDataTable(' + m.data.text.substring(m.data.text.indexOf("<pie>") + 5) + ');');
                  $("#charts").append("" + "var options = {" + "title: '" + m.data.text.substring(0, m.data.text.indexOf('<pie>')) + "', pieHole: 0.4,};");
                  $("#charts").append("var chart = new google.visualization.PieChart(document.getElementById('"+ m.data.messageID +"chart')); chart.draw(data, options);}");*/
                  //$("#charts").append(code);
                  /*if(!(messageList.length < 2) && messageList[messageList.length - 2].data.userID == m.data.userID) {
                    $("#" + messageList[messageList.length - 2].data.messageID + " .message").css("border-top-left-radius", '0px');
                    $("#" + messageList[messageList.length - 2].data.messageID).css("margin-top", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID+ " .message").css("border-bottom-left-radius", '0px');
                    $("#" + messageList[messageList.length - 1].data.messageID).css("margin-bottom", '0px');
                  }*/
                }
                $("#" + messageList[messageList.length - 1].data.messageID).animate({opacity: "1"}, 250);
              }
            } else if(m.type == "upVote") {
              var ind = opList.indexOf(m.data.id);
              if(ind >= 0) {
                upvotes[ind] = m.data.votes;
                voted[ind].push(m.data.userID);
                $("#" + m.data.id).text(m.data.name + ", " + m.data.votes);
                $("#" + m.data.id).after("<p>" + m.data.userID + "</p>");
              }
            }
          }

          function publish() {
            var t = $("#text").val();
            var mes;
            var counter = 0;
            var index1 = 0;
            var index2 = 0;
            var option = [];
            while(true) {
              index2 = t.indexOf("`", index1);
              if(index2 == -1) {
                if(counter == 0) {
                  mes = t;
                }
                break;
              } else if(counter == 0) {
                mes = t.substring(0, index2);
              }
              index1 = index2 + 1;
              index2 = t.indexOf("`", index1);
              if(index2 == -1) {
                option.push(t.substring(index1));
                break;
              }
              option.push(t.substring(index1, index2));
              index1 = index2 + 1;
              counter++;
            }
            PUBNUB_demo.publish({
              channel: network,
              message: {
                "data" : {
                  "text": mes,
                  "userID": name,
                  "messageID": new Date().getTime(),
                  "options": option
                },
                "type": "groupMessage"
              }
            });
          }

          $("#exit").click(function() {
              PUBNUB_demo.unsubscribe({
                "channel": network
              });
          });

        })();
      </script>
      <script type="text/javascript" src="https://www.google.com/jsapi"></script>
      <script id="charts" type="text/javascript">
      google.load("visualization", "1", {packages:["corechart"]});
      google.setOnLoadCallback(drawChart);function drawChart() {
      var data = google.visualization.arrayToDataTable([['Task', 'Hours per Day'],['Work',     11],['Eat',      2],['Commute',  2],['Watch TV', 2],['Sleep',    7]]);
      var options = {
        title: 'My Daily Activities', pieHole: 0.4,};
    var chart = new google.visualization.PieChart(document.getElementById('chart'));
        chart.draw(data, options);
      }
      </script>
    </div>
  </body>
</html>
